#!/bin/bash
rm -f ScanResults-01.csv
timeout 10 airodump-ng -w ScanResults --output-format csv wlan0mon & > /dev/null 2> /dev/null
sleep 15
pkill airodump-ng
sed -i 's/BSSID.*//g' ScanResults-01.csv
sed -n '/,/p' ScanResults-01.csv
sed -n '/Station/q;p' ScanResults-01.csv > scan.txt
sed '/^$/d' scan.txt > finalScan.txt
two=2
count=$(wc -l <  finalScan.txt)
x=2
c=0
output=""
while [ $x -lt  $count ]; do
	delimiter=,
	array=();
	p=p
	x=$x$p
	str=$(sed -n $x finalScan.txt)
	s=$str$delimiter
	while [[ $s ]]; do
		array+=( "${s%%"$delimiter"*}" );
		s=${s#*"$delimiter"};
	done;
	netw=network
	raspberry=$(sed -n 6p spiderNet.conf)
	network=$netw$c
	channel=${array[@]:3:1}
	BSSID=${array[@]:0:1}
	access_method=${array[@]:5:1}
	ip=${array[@]:11:1}
	ESSID=${array[@]:13:1}
	power=${array[@]:8:1}
#	echo $power
#	echo $ESSID
#	echo $access_method

	sed -i "s/raspi/$raspberry/g" jsonScript
	sed -i "s/somewhere/NULL/g" jsonScript
	sed -i "s/somebody/NULL/g" jsonScript
	sed -i "s/network0/$network/g" jsonScript
	sed -i "s/chanel/$channel/g" jsonScript
	sed -i "s/afreq/NULL/g" jsonScript
	sed -i "s/wide/NULL/g" jsonScript
	sed -i "s/whichone/$power/g" jsonScript
	sed -i "s/what/NULL/g" jsonScript
	sed -i "s/sit/$ESSID/g" jsonScript
	sed -i "s/thing/$BSSID/g" jsonScript
	sed -i "s/who/NULL/g" jsonScript
	sed -i "s/security/$access_method/g" jsonScript
	sed -i "s/important/NULL/g" jsonScript
	sed -i "s/conn/$ip/g" jsonScript
	sed -i "s/towhere/NULL/g" jsonScript
	sed -i "s/domain/NULL/g" jsonScript
	sed -i "s/extern/NULL/g" jsonScript

	export c
	./jsonScript
	json=$(<jsonSend.txt)
	rm -f jsonSend.txt
	output=$output$json

	sed -i "s/$raspberry/raspi/g" jsonScript
	sed -i "s/$network/network0/g" jsonScript
	sed -i "s/$channel/chanel/g" jsonScript
	sed -i "s/$BSSID/thing/g" jsonScript
	sed -i "s/$access_method/security/g" jsonScript
	sed -i "s/$ip/conn/g" jsonScript
	sed -i "s/$ESSID/sit/g" jsonScript
	sed -i "s/$power/whichone/g" jsonScript

	c=${c%?}
	c=$(($c+1))
	x=${x%?}
	x=$(($x+1))
done;

echo "$output" > "jsonSend.txt"
truncate -s-2 jsonSend.txt
output=$(<jsonSend.txt)
rm -f jsonSend.txt
c=n
export c
./jsonScript
temp3=$(<jsonSend.txt)
rm -f jsonSend.txt
output=$output$temp3
echo $output
echo "$output" > "toBroker.txt"
email=$(sed -n 2p spiderNet.conf)
passwd=$(sed -n 4p spiderNet.conf)
raspberryName=$(sed -n 6p spiderNet.conf)
topicToPublish=$email"/"$raspberryName
mosquitto_pub -r -h lavis.ddns.net -t $topicToPublish -p 8883 --cert /home/pi/keys/cloudfare.at.pem --key /home/pi/keys/cloudfare.at.key -f toBroker.txt -u $email -P $passwd
rm -f toBroker.txt

